name: Build and Publish All Platforms

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  # ================================================================
  # 1. Android 构建
  # ================================================================
  build-android:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      - name: Decode Keystore
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        if: ${{ env.ANDROID_KEYSTORE_BASE64 != '' }}
        run: |
          echo "$ANDROID_KEYSTORE_BASE64" | base64 --decode > "${{ github.workspace }}/release.keystore"

      - name: Build Android
        run: ./gradlew :composeApp:assembleRelease :composeApp:bundleRelease
        env:
          SIGNING_STORE_FILE: ${{ github.workspace }}/release.keystore
          SIGNING_STORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          SIGNING_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          SIGNING_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}

      - name: Rename Android Artifacts
        run: |
          mv composeApp/build/outputs/apk/release/composeApp-release.apk app-release.apk
          mv composeApp/build/outputs/bundle/release/composeApp-release.aab app-release.aab

      - name: Upload Android Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-artifacts
          path: |
            app-release.apk
            app-release.aab

  # ================================================================
  # 2. Windows 构建
  # ================================================================
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Build Windows Targets
        run: ./gradlew :composeApp:packageReleaseExe :composeApp:packageReleaseMsi :composeApp:createReleaseDistributable

      - name: Create Portable Zip
        shell: pwsh
        run: |
          $Version = "${{ github.ref_name }}"
          Compress-Archive -Path composeApp/build/compose/binaries/main/app/* `
            -DestinationPath "windows-portable-$Version.zip"

      - name: Upload Windows Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-artifacts
          path: |
            composeApp/build/compose/binaries/main/exe/*.exe
            composeApp/build/compose/binaries/main/msi/*.msi
            *.zip

  # ================================================================
  # 3. macOS 构建
  # ================================================================
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      - name: Build macOS Targets
        run: ./gradlew :composeApp:packageReleaseDmg :composeApp:packageReleasePkg

      - name: Upload macOS Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-artifacts
          path: |
            composeApp/build/compose/binaries/main/dmg/*.dmg
            composeApp/build/compose/binaries/main/pkg/*.pkg

  # ================================================================
  # 4. Linux 构建
  # ================================================================
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      - name: Install Linux Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y rpm fakeroot binutils

      - name: Build Linux Targets
        run: ./gradlew \
          :composeApp:packageReleaseDeb \
          :composeApp:packageReleaseRpm \
          :composeApp:packageReleaseAppImage

      - name: Upload Linux Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-artifacts
          path: |
            composeApp/build/compose/binaries/main/deb/*.deb
            composeApp/build/compose/binaries/main/rpm/*.rpm
            composeApp/build/compose/binaries/main/appImage/*.AppImage

  # ================================================================
  # 5. 创建 GitHub Release
  # ================================================================
  release:
    needs: [build-android, build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
          merge-multiple: true

      - name: List Files
        run: ls -R ./artifacts

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: ./artifacts/*
          generate_release_notes: true
